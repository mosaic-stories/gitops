# Staging Environment Configuration
# Updated automatically by GitHub Actions on merge to develop

global:
  imageTag: "staging-5857ac8"
  domain: "stage.mosaiclife.me"
  environment: staging
web:
  replicaCount: 1
  autoscaling:
    enabled: false
  podDisruptionBudget:
    enabled: false
  ingress:
    annotations:
      # Note: Environment tag removed because ALB is shared with prod via group.name
      alb.ingress.kubernetes.io/tags: "Project=MosaicLife,Component=web"
      external-dns.alpha.kubernetes.io/hostname: "stage.mosaiclife.me"
    hosts:
      - host: stage.mosaiclife.me
        paths:
          - path: /
            pathType: Prefix
coreApi:
  replicaCount: 1
  autoscaling:
    enabled: false
  podDisruptionBudget:
    enabled: false
  serviceAccount:
    annotations:
      eks.amazonaws.com/role-arn: arn:aws:iam::033691785857:role/mosaic-staging-core-api-role
  ingress:
    annotations:
      # Note: Environment tag removed because ALB is shared with prod via group.name
      alb.ingress.kubernetes.io/tags: "Project=MosaicLife,Component=backend"
      external-dns.alpha.kubernetes.io/hostname: "stage-api.mosaiclife.me"
      # SSE/Streaming support - required for AI chat streaming responses
      alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=3600
      # Use HTTP1 backend protocol for proper chunked transfer encoding (SSE streaming)
      alb.ingress.kubernetes.io/backend-protocol-version: HTTP1
    hosts:
      - host: stage-api.mosaiclife.me
        paths:
          - path: /
            pathType: Prefix
  # Full environment configuration for staging
  # NOTE: Helm does not deep-merge arrays, so we must include the complete env array here
  env:
    - name: PORT
      value: "8080"
    - name: ENVIRONMENT
      value: "staging"
    - name: LOG_LEVEL
      value: "info"
    - name: AWS_REGION
      value: "us-east-1"
    # Google OAuth Configuration
    - name: GOOGLE_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: google-oauth
          key: client-id
    - name: GOOGLE_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: google-oauth
          key: client-secret
    # Application URLs
    - name: APP_URL
      value: "https://stage.mosaiclife.me"
    - name: API_URL
      value: "https://stage-api.mosaiclife.me"
    # SES Email Configuration
    - name: SES_FROM_EMAIL
      value: "noreply@mosaiclife.me"
    - name: SES_REGION
      value: "us-east-1"
    # Session Configuration
    - name: SESSION_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: session-secret
          key: secret-key
    - name: SESSION_COOKIE_DOMAIN
      value: ".mosaiclife.me"
    # AWS S3 Configuration
    - name: STORAGE_BACKEND
      value: "s3"
    - name: S3_MEDIA_BUCKET
      value: "mosaic-staging-media-033691785857"
    - name: S3_BACKUP_BUCKET
      value: "mosaic-staging-backups-033691785857"
    # Database URL from External Secrets
    - name: DB_URL
      valueFrom:
        secretKeyRef:
          name: database-credentials
          key: DB_URL
    # Bedrock AI Guardrails (staging-specific guardrail)
    - name: BEDROCK_GUARDRAIL_ID
      value: "a1kbuwc508sp"
    - name: BEDROCK_GUARDRAIL_VERSION
      value: "1"
externalSecrets:
  database:
    secretKey: "mosaic/staging/rds/credentials"
  session:
    secretKey: "mosaic/staging/session/secret-key"
